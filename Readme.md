# Сравнение Bluetooth аудиокодеков

Тестовый трек: **Rammstein — Deutschland**

---

## Baseline: Сбер Звук (стриминг)

Пример потерь, слышимых невооружённым ухом.  
Трек загружен пользователем, поэтому непонятно, что там лежит.

**Корреляция: 0.994 | RMS: 0.108**

```
         0-50 Hz:   15.9% ▓▓▓░░░░░░░░░░░░░░░░░
        5-100 Hz:    8.9% ▓░░░░░░░░░░░░░░░░░░░
      100-200 Hz:    7.2% ▓░░░░░░░░░░░░░░░░░░░
       200-1k Hz:    8.2% ▓░░░░░░░░░░░░░░░░░░░
        1k-2k Hz:    7.5% ▓░░░░░░░░░░░░░░░░░░░
        2k-4k Hz:   12.4% ▓▓░░░░░░░░░░░░░░░░░░
        4k-6k Hz:    5.9% ▓░░░░░░░░░░░░░░░░░░░
        6k-8k Hz:    6.3% ▓░░░░░░░░░░░░░░░░░░░
       8k-10k Hz:    9.4% ▓░░░░░░░░░░░░░░░░░░░
       8k-12k Hz:   14.4% ▓▓░░░░░░░░░░░░░░░░░░
      12k-14k Hz:   31.6% ▓▓▓▓▓▓░░░░░░░░░░░░░░
      12k-16k Hz:   28.7% ▓▓▓▓▓░░░░░░░░░░░░░░░
      16k-18k Hz:   20.5% ▓▓▓▓░░░░░░░░░░░░░░░░
      18k-20k Hz:   41.2% ▓▓▓▓▓▓▓▓░░░░░░░░░░░░
```

---

## Аналоговый тракт (DAC → ADC)

Подаём сигнал на ЦАП через Bluetooth/USB, снимаем с АЦП.

### USB (проводное)

Искажения на низах и верхних частотах связаны со свойствами ЦАПа и АЦП.

**Корреляция: 0.950 | RMS: 0.315**

```
         0-50 Hz:   20.2% ▓▓▓▓░░░░░░░░░░░░░░░░
        5-100 Hz:    5.8% ▓░░░░░░░░░░░░░░░░░░░
      100-200 Hz:    4.5% ░░░░░░░░░░░░░░░░░░░░
       200-1k Hz:    4.6% ░░░░░░░░░░░░░░░░░░░░
        1k-2k Hz:    4.6% ░░░░░░░░░░░░░░░░░░░░
        2k-4k Hz:    4.5% ░░░░░░░░░░░░░░░░░░░░
        4k-6k Hz:    4.5% ░░░░░░░░░░░░░░░░░░░░
        6k-8k Hz:    4.4% ░░░░░░░░░░░░░░░░░░░░
       8k-10k Hz:    4.4% ░░░░░░░░░░░░░░░░░░░░
       8k-12k Hz:    4.4% ░░░░░░░░░░░░░░░░░░░░
      12k-14k Hz:    4.5% ░░░░░░░░░░░░░░░░░░░░
      12k-16k Hz:    5.0% ░░░░░░░░░░░░░░░░░░░░
      16k-18k Hz:   14.3% ▓▓░░░░░░░░░░░░░░░░░░
      18k-20k Hz:   47.2% ▓▓▓▓▓▓▓▓▓░░░░░░░░░░░
```

### LDAC

**Корреляция: 0.923 | RMS: 0.392**

```
         0-50 Hz:   17.2% ▓▓▓░░░░░░░░░░░░░░░░░
        5-100 Hz:    2.8% ░░░░░░░░░░░░░░░░░░░░
      100-200 Hz:    1.2% ░░░░░░░░░░░░░░░░░░░░
       200-1k Hz:    1.4% ░░░░░░░░░░░░░░░░░░░░
        1k-2k Hz:    1.4% ░░░░░░░░░░░░░░░░░░░░
        2k-4k Hz:    1.3% ░░░░░░░░░░░░░░░░░░░░
        4k-6k Hz:    1.3% ░░░░░░░░░░░░░░░░░░░░
        6k-8k Hz:    1.3% ░░░░░░░░░░░░░░░░░░░░
       8k-10k Hz:    1.4% ░░░░░░░░░░░░░░░░░░░░
       8k-12k Hz:    1.5% ░░░░░░░░░░░░░░░░░░░░
      12k-14k Hz:    2.4% ░░░░░░░░░░░░░░░░░░░░
      12k-16k Hz:    3.4% ░░░░░░░░░░░░░░░░░░░░
      16k-18k Hz:   15.2% ▓▓▓░░░░░░░░░░░░░░░░░
      18k-20k Hz:   46.4% ▓▓▓▓▓▓▓▓▓░░░░░░░░░░░
```

### USB vs LDAC (прямое сравнение)

**Корреляция: 0.987 | RMS: 0.161**

```
         0-50 Hz:    0.7% ░░░░░░░░░░░░░░░░░░░░
        5-100 Hz:    0.2% ░░░░░░░░░░░░░░░░░░░░
      100-200 Hz:    0.2% ░░░░░░░░░░░░░░░░░░░░
       200-1k Hz:    0.2% ░░░░░░░░░░░░░░░░░░░░
        1k-2k Hz:    0.2% ░░░░░░░░░░░░░░░░░░░░
        2k-4k Hz:    0.2% ░░░░░░░░░░░░░░░░░░░░
        4k-6k Hz:    0.2% ░░░░░░░░░░░░░░░░░░░░
        6k-8k Hz:    0.2% ░░░░░░░░░░░░░░░░░░░░
       8k-10k Hz:    0.3% ░░░░░░░░░░░░░░░░░░░░
       8k-12k Hz:    0.5% ░░░░░░░░░░░░░░░░░░░░
      12k-14k Hz:    1.2% ░░░░░░░░░░░░░░░░░░░░
      12k-16k Hz:    2.0% ░░░░░░░░░░░░░░░░░░░░
      16k-18k Hz:    9.0% ▓░░░░░░░░░░░░░░░░░░░
      18k-20k Hz:   22.9% ▓▓▓▓░░░░░░░░░░░░░░░░
```

**Вывод:** LDAC практически неотличим от USB в аналоговом тракте.

---

## Цифровой тракт (Bluetooth → PC)

Чистое сравнение кодеков без аналоговых потерь: передаем сигнал напрямую на компьютер (windows/linux) и записываем цифру.

### Windows Loopback 24bit/48kHz (референс)

**Корреляция: 0.999999 | RMS: 0.001**

```
         0-50 Hz:    0.1% ░░░░░░░░░░░░░░░░░░░░
        5-100 Hz:    0.0% ░░░░░░░░░░░░░░░░░░░░
      100-200 Hz:    0.0% ░░░░░░░░░░░░░░░░░░░░
       200-1k Hz:    0.0% ░░░░░░░░░░░░░░░░░░░░
        1k-2k Hz:    0.0% ░░░░░░░░░░░░░░░░░░░░
        2k-4k Hz:    0.0% ░░░░░░░░░░░░░░░░░░░░
        4k-6k Hz:    0.0% ░░░░░░░░░░░░░░░░░░░░
        6k-8k Hz:    0.0% ░░░░░░░░░░░░░░░░░░░░
       8k-10k Hz:    0.1% ░░░░░░░░░░░░░░░░░░░░
       8k-12k Hz:    0.2% ░░░░░░░░░░░░░░░░░░░░
      12k-14k Hz:    0.6% ░░░░░░░░░░░░░░░░░░░░
      12k-16k Hz:    0.8% ░░░░░░░░░░░░░░░░░░░░
      16k-18k Hz:    1.5% ░░░░░░░░░░░░░░░░░░░░
      18k-20k Hz:    2.4% ░░░░░░░░░░░░░░░░░░░░
```

### Windows Loopback 16bit/44.1kHz

Этот пример показывает, что нельзя использовать `virtual cable` с частотой сэмплирования отлично от **48кГц.**

**Корреляция: 0.999315 | RMS: 0.037**

```
         0-50 Hz:    0.8% ░░░░░░░░░░░░░░░░░░░░
        5-100 Hz:    0.8% ░░░░░░░░░░░░░░░░░░░░
      100-200 Hz:    0.8% ░░░░░░░░░░░░░░░░░░░░
       200-1k Hz:    0.8% ░░░░░░░░░░░░░░░░░░░░
        1k-2k Hz:    0.9% ░░░░░░░░░░░░░░░░░░░░
        2k-4k Hz:    2.8% ░░░░░░░░░░░░░░░░░░░░
        4k-6k Hz:    7.7% ▓░░░░░░░░░░░░░░░░░░░
        6k-8k Hz:   16.3% ▓▓▓░░░░░░░░░░░░░░░░░
       8k-10k Hz:   30.4% ▓▓▓▓▓▓░░░░░░░░░░░░░░
       8k-12k Hz:   38.1% ▓▓▓▓▓▓▓░░░░░░░░░░░░░
      12k-14k Hz:   55.5% ▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░
      12k-16k Hz:   59.2% ▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░
      16k-18k Hz:   67.3% ▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░
      18k-20k Hz:   67.4% ▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░░
```

**Вывод:** Записывать надо только в 24bit/48kHz, иначе ресемплинг убивает верха.

---

### SBC (Windows)

**Корреляция: 0.999749 | RMS: 0.022**

```
         0-50 Hz:    3.6% ░░░░░░░░░░░░░░░░░░░░
        5-100 Hz:    1.0% ░░░░░░░░░░░░░░░░░░░░
      100-200 Hz:    0.3% ░░░░░░░░░░░░░░░░░░░░
       200-1k Hz:    1.3% ░░░░░░░░░░░░░░░░░░░░
        1k-2k Hz:    1.9% ░░░░░░░░░░░░░░░░░░░░
        2k-4k Hz:    4.4% ░░░░░░░░░░░░░░░░░░░░
        4k-6k Hz:    6.1% ▓░░░░░░░░░░░░░░░░░░░
        6k-8k Hz:    8.8% ▓░░░░░░░░░░░░░░░░░░░
       8k-10k Hz:   13.4% ▓▓░░░░░░░░░░░░░░░░░░
       8k-12k Hz:   17.8% ▓▓▓░░░░░░░░░░░░░░░░░
      12k-14k Hz:   26.8% ▓▓▓▓▓░░░░░░░░░░░░░░░
      12k-16k Hz:   32.4% ▓▓▓▓▓▓░░░░░░░░░░░░░░
      16k-18k Hz:   75.7% ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░
      18k-20k Hz:  120.1% ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
```

### SBC (Linux)

**Корреляция: 0.996574 | RMS: 0.083**

```
         0-50 Hz:    3.9% ░░░░░░░░░░░░░░░░░░░░
        5-100 Hz:    1.2% ░░░░░░░░░░░░░░░░░░░░
      100-200 Hz:    0.3% ░░░░░░░░░░░░░░░░░░░░
       200-1k Hz:    1.4% ░░░░░░░░░░░░░░░░░░░░
        1k-2k Hz:    1.9% ░░░░░░░░░░░░░░░░░░░░
        2k-4k Hz:    4.4% ░░░░░░░░░░░░░░░░░░░░
        4k-6k Hz:    6.1% ▓░░░░░░░░░░░░░░░░░░░
        6k-8k Hz:    8.8% ▓░░░░░░░░░░░░░░░░░░░
       8k-10k Hz:   13.4% ▓▓░░░░░░░░░░░░░░░░░░
       8k-12k Hz:   17.9% ▓▓▓░░░░░░░░░░░░░░░░░
      12k-14k Hz:   26.9% ▓▓▓▓▓░░░░░░░░░░░░░░░
      12k-16k Hz:   32.5% ▓▓▓▓▓▓░░░░░░░░░░░░░░
      16k-18k Hz:   75.7% ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░
      18k-20k Hz:  118.8% ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
```

**Вывод:** SBC идентичен на Windows и Linux. Режет всё выше 16 кГц.

---

### AAC

**Корреляция: 0.993307 | RMS: 0.116**

```
         0-50 Hz:   21.8% ▓▓▓▓░░░░░░░░░░░░░░░░
        5-100 Hz:    8.8% ▓░░░░░░░░░░░░░░░░░░░
      100-200 Hz:    4.6% ░░░░░░░░░░░░░░░░░░░░
       200-1k Hz:    9.7% ▓░░░░░░░░░░░░░░░░░░░
        1k-2k Hz:   15.8% ▓▓▓░░░░░░░░░░░░░░░░░
        2k-4k Hz:   15.6% ▓▓▓░░░░░░░░░░░░░░░░░
        4k-6k Hz:   15.8% ▓▓▓░░░░░░░░░░░░░░░░░
        6k-8k Hz:   21.0% ▓▓▓▓░░░░░░░░░░░░░░░░
       8k-10k Hz:   32.4% ▓▓▓▓▓▓░░░░░░░░░░░░░░
       8k-12k Hz:   41.4% ▓▓▓▓▓▓▓▓░░░░░░░░░░░░
      12k-14k Hz:   54.5% ▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░
      12k-16k Hz:   59.9% ▓▓▓▓▓▓▓▓▓▓▓░░░░░░░░░
      16k-18k Hz:  152.8% ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
      18k-20k Hz:  183.4% ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
```

**Вывод:** На первый взгляд `AAC` хуже `SBC`, я хотел что-нибудь сказать про психоакустику, но тут все реально фигово. Плохая реализация в linux?

---

### aptX

**Корреляция: 0.999043 | RMS: 0.044**

```
         0-50 Hz:    4.0% ░░░░░░░░░░░░░░░░░░░░
        5-100 Hz:    1.2% ░░░░░░░░░░░░░░░░░░░░
      100-200 Hz:    0.3% ░░░░░░░░░░░░░░░░░░░░
       200-1k Hz:    1.4% ░░░░░░░░░░░░░░░░░░░░
        1k-2k Hz:    1.9% ░░░░░░░░░░░░░░░░░░░░
        2k-4k Hz:    4.4% ░░░░░░░░░░░░░░░░░░░░
        4k-6k Hz:    6.0% ▓░░░░░░░░░░░░░░░░░░░
        6k-8k Hz:    8.7% ▓░░░░░░░░░░░░░░░░░░░
       8k-10k Hz:   13.4% ▓▓░░░░░░░░░░░░░░░░░░
       8k-12k Hz:   17.8% ▓▓▓░░░░░░░░░░░░░░░░░
      12k-14k Hz:   26.9% ▓▓▓▓▓░░░░░░░░░░░░░░░
      12k-16k Hz:   32.5% ▓▓▓▓▓▓░░░░░░░░░░░░░░
      16k-18k Hz:   75.8% ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░░░░
      18k-20k Hz:  118.9% ▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓
```

**Вывод:** aptX идентичен SBC по частотам.

---

### aptX HD

**Корреляция: 0.999074 | RMS: 0.043**

```
         0-50 Hz:    6.5% ▓░░░░░░░░░░░░░░░░░░░
        5-100 Hz:    2.3% ░░░░░░░░░░░░░░░░░░░░
      100-200 Hz:    0.5% ░░░░░░░░░░░░░░░░░░░░
       200-1k Hz:    1.6% ░░░░░░░░░░░░░░░░░░░░
        1k-2k Hz:    2.1% ░░░░░░░░░░░░░░░░░░░░
        2k-4k Hz:    2.5% ░░░░░░░░░░░░░░░░░░░░
        4k-6k Hz:    4.1% ░░░░░░░░░░░░░░░░░░░░
        6k-8k Hz:    8.7% ▓░░░░░░░░░░░░░░░░░░░
       8k-10k Hz:   17.8% ▓▓▓░░░░░░░░░░░░░░░░░
       8k-12k Hz:   23.8% ▓▓▓▓░░░░░░░░░░░░░░░░
      12k-14k Hz:   28.3% ▓▓▓▓▓░░░░░░░░░░░░░░░
      12k-16k Hz:   32.3% ▓▓▓▓▓▓░░░░░░░░░░░░░░
      16k-18k Hz:   37.1% ▓▓▓▓▓▓▓░░░░░░░░░░░░░
      18k-20k Hz:   38.0% ▓▓▓▓▓▓▓░░░░░░░░░░░░░
```

**Вывод:** aptX HD значительно лучше сохраняет верха (38% vs 119% у aptX).

---

## Выводы

1. **aptX HD** — лучший доступный кодек, минимальные потери на верхах
2. **SBC и aptX** — практически идентичны, режут всё выше 16 кГц
3. **AAC** — неожиданно худший результат, потери по всему диапазону
4. **LDAC** — пости losless качество

---

## Настройка Linux для приёма Bluetooth аудио

Windows + `blueatooth audio reciever` умеет только в SBC, поэтому мы используем линукс для наших целей.  
Стандартный `PipeWire/WirePlumber` поддерживает только SBC. Для AAC/aptX нужен [bluez-alsa](https://github.com/arkq/bluez-alsa):

```bash
# Зависимости
sudo apt install git automake libtool pkg-config libasound2-dev \
    libbluetooth-dev libdbus-1-dev libglib2.0-dev libsbc-dev \
    libfdk-aac-dev libavcodec-dev libldacbt-enc-dev libldacbt-abr-dev

# openaptx
cd /tmp && git clone --branch v2.0.0 https://github.com/arkq/openaptx.git
cd openaptx && mkdir build && cd build
cmake -DWITH_FFMPEG=ON .. && make && sudo make install && sudo ldconfig

# bluez-alsa
cd /tmp && git clone https://github.com/Arkq/bluez-alsa.git
cd bluez-alsa && autoreconf --install && mkdir build && cd build
export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
../configure --enable-aac --enable-aptx --enable-aptx-hd --enable-ldac
make -j$(nproc) && sudo make install

# Отключить bluetooth в wireplumber
mkdir -p ~/.config/wireplumber/bluetooth.lua.d/
echo "bluez_monitor.enabled = false" > ~/.config/wireplumber/bluetooth.lua.d/99-disable.lua
systemctl --user restart pipewire pipewire-pulse wireplumber

# Запуск
sudo /usr/bin/bluealsad -p a2dp-sink -c aptx-hd &
bluetoothctl connect XX:XX:XX:XX:XX:XX

# Запись
arecord -D bluealsa:DEV=XX:XX:XX:XX:XX:XX,PROFILE=a2dp -f cd -t wav output.wav
```
